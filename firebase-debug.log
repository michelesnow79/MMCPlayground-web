[debug] [2026-02-19T03:10:52.831Z] ----------------------------------------------------------------------
[debug] [2026-02-19T03:10:52.839Z] Command:       C:\nvm4w\nodejs\node.exe C:\Users\Michele\AppData\Roaming\npm\node_modules\firebase-tools\lib\bin\firebase.js deploy --only firestore:rules
[debug] [2026-02-19T03:10:52.840Z] CLI Version:   15.1.0
[debug] [2026-02-19T03:10:52.840Z] Platform:      win32
[debug] [2026-02-19T03:10:52.840Z] Node Version:  v20.20.0
[debug] [2026-02-19T03:10:52.840Z] Time:          Wed Feb 18 2026 22:10:52 GMT-0500 (Eastern Standard Time)
[debug] [2026-02-19T03:10:52.841Z] ----------------------------------------------------------------------
[debug] 
[debug] [2026-02-19T03:13:09.079Z] > command requires scopes: ["email","openid","https://www.googleapis.com/auth/cloudplatformprojects.readonly","https://www.googleapis.com/auth/firebase","https://www.googleapis.com/auth/cloud-platform"]
[debug] [2026-02-19T03:13:09.081Z] > authorizing via signed-in user (michelesnow@gmail.com)
[debug] [2026-02-19T03:13:09.081Z] [iam] checking project mmcplayground for permissions ["datastore.indexes.create","datastore.indexes.delete","datastore.indexes.list","datastore.indexes.update","firebase.projects.get"]
[debug] [2026-02-19T03:13:09.084Z] Checked if tokens are valid: false, expires at: 1771463771309
[debug] [2026-02-19T03:13:09.084Z] Checked if tokens are valid: false, expires at: 1771463771309
[debug] [2026-02-19T03:13:09.085Z] > refreshing access token with scopes: []
[debug] [2026-02-19T03:13:09.113Z] >>> [apiv2][query] POST https://www.googleapis.com/oauth2/v3/token [none]
[debug] [2026-02-19T03:13:09.115Z] >>> [apiv2][body] POST https://www.googleapis.com/oauth2/v3/token [omitted]
[debug] [2026-02-19T03:13:09.963Z] <<< [apiv2][status] POST https://www.googleapis.com/oauth2/v3/token 200
[debug] [2026-02-19T03:13:09.964Z] <<< [apiv2][body] POST https://www.googleapis.com/oauth2/v3/token [omitted]
[debug] [2026-02-19T03:13:10.067Z] >>> [apiv2][query] POST https://cloudresourcemanager.googleapis.com/v1/projects/mmcplayground:testIamPermissions [none]
[debug] [2026-02-19T03:13:10.068Z] >>> [apiv2][(partial)header] POST https://cloudresourcemanager.googleapis.com/v1/projects/mmcplayground:testIamPermissions x-goog-quota-user=projects/mmcplayground
[debug] [2026-02-19T03:13:10.069Z] >>> [apiv2][body] POST https://cloudresourcemanager.googleapis.com/v1/projects/mmcplayground:testIamPermissions {"permissions":["datastore.indexes.create","datastore.indexes.delete","datastore.indexes.list","datastore.indexes.update","firebase.projects.get"]}
[debug] [2026-02-19T03:13:10.252Z] <<< [apiv2][status] POST https://cloudresourcemanager.googleapis.com/v1/projects/mmcplayground:testIamPermissions 200
[debug] [2026-02-19T03:13:10.252Z] <<< [apiv2][body] POST https://cloudresourcemanager.googleapis.com/v1/projects/mmcplayground:testIamPermissions {"permissions":["datastore.indexes.create","datastore.indexes.delete","datastore.indexes.list","datastore.indexes.update","firebase.projects.get"]}
[info] 
[info] === Deploying to 'mmcplayground'...
[info] 
[info] i  deploying firestore 
[info] i  firestore: ensuring required API firestore.googleapis.com is enabled... 
[info] i  firestore: ensuring required API firestore.googleapis.com is enabled... 
[debug] [2026-02-19T03:13:10.288Z] Checked if tokens are valid: true, expires at: 1771474388966
[debug] [2026-02-19T03:13:10.289Z] Checked if tokens are valid: true, expires at: 1771474388966
[debug] [2026-02-19T03:13:10.290Z] >>> [apiv2][query] GET https://firestore.googleapis.com/v1/projects/mmcplayground/databases/(default) [none]
[debug] [2026-02-19T03:13:10.748Z] <<< [apiv2][status] GET https://firestore.googleapis.com/v1/projects/mmcplayground/databases/(default) 200
[debug] [2026-02-19T03:13:10.749Z] <<< [apiv2][body] GET https://firestore.googleapis.com/v1/projects/mmcplayground/databases/(default) {"name":"projects/mmcplayground/databases/(default)","uid":"d7c155b1-36fc-494c-9c65-682630320723","createTime":"2026-02-14T17:33:08.793144Z","updateTime":"2026-02-14T17:33:08.793144Z","locationId":"nam5","type":"FIRESTORE_NATIVE","concurrencyMode":"PESSIMISTIC","versionRetentionPeriod":"3600s","earliestVersionTime":"2026-02-19T02:13:11.070354Z","appEngineIntegrationMode":"DISABLED","keyPrefix":"s","pointInTimeRecoveryEnablement":"POINT_IN_TIME_RECOVERY_DISABLED","deleteProtectionState":"DELETE_PROTECTION_DISABLED","databaseEdition":"STANDARD","freeTier":true,"realtimeUpdatesMode":"REALTIME_UPDATES_MODE_ENABLED","etag":"INae7fnK5JIDMJLd2PH82ZID"}
[info] i  firestore: reading indexes from firestore.indexes.json... 
[info] i  cloud.firestore: checking firestore.rules for compilation errors... 
[debug] [2026-02-19T03:13:11.018Z] Checked if tokens are valid: true, expires at: 1771474388966
[debug] [2026-02-19T03:13:11.018Z] Checked if tokens are valid: true, expires at: 1771474388966
[debug] [2026-02-19T03:13:11.019Z] >>> [apiv2][query] POST https://firebaserules.googleapis.com/v1/projects/mmcplayground:test [none]
[debug] [2026-02-19T03:13:11.019Z] >>> [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/mmcplayground:test [omitted]
[debug] [2026-02-19T03:13:11.493Z] <<< [apiv2][status] POST https://firebaserules.googleapis.com/v1/projects/mmcplayground:test 200
[debug] [2026-02-19T03:13:11.493Z] <<< [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/mmcplayground:test {}
[info] +  cloud.firestore: rules file firestore.rules compiled successfully 
[debug] [2026-02-19T03:13:11.611Z] Checked if tokens are valid: true, expires at: 1771474388966
[debug] [2026-02-19T03:13:11.617Z] Checked if tokens are valid: true, expires at: 1771474388966
[debug] [2026-02-19T03:13:11.631Z] >>> [apiv2][query] GET https://firebaserules.googleapis.com/v1/projects/mmcplayground/releases pageSize=10&pageToken=
[debug] [2026-02-19T03:13:11.826Z] <<< [apiv2][status] GET https://firebaserules.googleapis.com/v1/projects/mmcplayground/releases 200
[debug] [2026-02-19T03:13:11.827Z] <<< [apiv2][body] GET https://firebaserules.googleapis.com/v1/projects/mmcplayground/releases {"releases":[{"name":"projects/mmcplayground/releases/cloud.firestore","rulesetName":"projects/mmcplayground/rulesets/196a3a27-7c02-486c-a5a8-57e8a6497fa2","createTime":"2026-02-14T17:33:13.420231Z","updateTime":"2026-02-18T13:03:00.668048Z"}]}
[debug] [2026-02-19T03:13:11.828Z] Checked if tokens are valid: true, expires at: 1771474388966
[debug] [2026-02-19T03:13:11.828Z] Checked if tokens are valid: true, expires at: 1771474388966
[debug] [2026-02-19T03:13:11.828Z] >>> [apiv2][query] GET https://firebaserules.googleapis.com/v1/projects/mmcplayground/rulesets/196a3a27-7c02-486c-a5a8-57e8a6497fa2 [none]
[debug] [2026-02-19T03:13:11.959Z] <<< [apiv2][status] GET https://firebaserules.googleapis.com/v1/projects/mmcplayground/rulesets/196a3a27-7c02-486c-a5a8-57e8a6497fa2 200
[debug] [2026-02-19T03:13:11.959Z] <<< [apiv2][body] GET https://firebaserules.googleapis.com/v1/projects/mmcplayground/rulesets/196a3a27-7c02-486c-a5a8-57e8a6497fa2 [omitted]
[info] i  firestore: uploading rules firestore.rules... 
[debug] [2026-02-19T03:13:11.985Z] Checked if tokens are valid: true, expires at: 1771474388966
[debug] [2026-02-19T03:13:11.985Z] Checked if tokens are valid: true, expires at: 1771474388966
[debug] [2026-02-19T03:13:11.986Z] >>> [apiv2][query] POST https://firebaserules.googleapis.com/v1/projects/mmcplayground/rulesets [none]
[debug] [2026-02-19T03:13:11.987Z] >>> [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/mmcplayground/rulesets [omitted]
[debug] [2026-02-19T03:13:12.330Z] <<< [apiv2][status] POST https://firebaserules.googleapis.com/v1/projects/mmcplayground/rulesets 200
[debug] [2026-02-19T03:13:12.331Z] <<< [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/mmcplayground/rulesets {"name":"projects/mmcplayground/rulesets/36435d1b-3cf8-4959-b36e-a4281e4c9a4f","source":{"files":[{"content":"rules_version = '2';\r\nservice cloud.firestore {\r\n  match /databases/{database}/documents {\r\n    \r\n    // --- HELPER FUNCTIONS ---\r\n    function isSignedIn() {\r\n      return request.auth != null;\r\n    }\r\n    \r\n    // Simplified check compatible with 'array-contains' queries\r\n    function isParticipant(data) {\r\n      return isSignedIn() && request.auth.uid in data.participants;\r\n    }\r\n    \r\n    // Check if the current user is listed in the batch-created thread doc\r\n    function isParticipantInFutureThread(threadId) {\r\n      return getAfter(/databases/$(database)/documents/threads/$(threadId)).data.participants.hasAny([request.auth.uid]);\r\n    }\r\n\r\n    // --- THREADS AND MESSAGES ---\r\n    match /threads/{threadId} {\r\n      // 1. READ: Explicit OR check matching the new query\r\n      allow read: if isSignedIn() \r\n                  && (request.auth.uid == resource.data.ownerUid || request.auth.uid == resource.data.responderUid);\r\n\r\n      // 2. CREATE: Strict Integrity (New threads only)\r\n      allow create: if isSignedIn() \r\n                    // Keys check\r\n                    && request.resource.data.keys().hasAll(['participants', 'ownerUid', 'responderUid', 'pinId'])\r\n                    \r\n                    // STRICT PARTICIPANTS: Exactly 2 UIDs\r\n                    && request.resource.data.participants.size() == 2\r\n                    \r\n                    // User must be one of the participants\r\n                    && request.resource.data.participants.hasAny([request.auth.uid])\r\n                    \r\n                    // Enforce canonical ID pattern: pinId_responderUid\r\n                    && threadId == request.resource.data.pinId + \"_\" + request.resource.data.responderUid\r\n                    \r\n                    // Integrity: Pin must exist\r\n                    && exists(/databases/$(database)/documents/pins/$(request.resource.data.pinId))\r\n                    \r\n                    // Integrity: Owner must be the correct Pin Owner (fetched from DB)\r\n                    && request.resource.data.ownerUid == get(/databases/$(database)/documents/pins/$(request.resource.data.pinId)).data.ownerUid\r\n                    \r\n                    // Integrity: Participants must exactly match [ownerUid, responderUid]\r\n                    && request.resource.data.participants.hasAll([request.resource.data.ownerUid, request.resource.data.responderUid])\r\n                    \r\n                    // Integrity: Responder cannot be Owner\r\n                    && request.resource.data.ownerUid != request.resource.data.responderUid;\r\n\r\n      // 3. UPDATE: Allow if user is a participant\r\n      allow update: if isParticipant(resource.data);\r\n\r\n      match /messages/{messageId} {\r\n        // READ: Allow if parent thread participant (using safe hasAny)\r\n        allow read: if isSignedIn() \r\n                    && get(/databases/$(database)/documents/threads/$(threadId)).data.participants.hasAny([request.auth.uid]);\r\n\r\n        // CREATE:\r\n        // Case A: Thread Exists -> Check existing participants using hasAny\r\n        // Case B: New Thread (Batch) -> Check future thread participants using hasAny\r\n        allow create: if isSignedIn()\r\n                      && request.resource.data.senderUid == request.auth.uid\r\n                      && request.resource.data.content.size() <= 2000\r\n                      && (\r\n                        (exists(/databases/$(database)/documents/threads/$(threadId)) && \r\n                         get(/databases/$(database)/documents/threads/$(threadId)).data.participants.hasAny([request.auth.uid]))\r\n                        ||\r\n                        (!exists(/databases/$(database)/documents/threads/$(threadId)) && \r\n                         isParticipantInFutureThread(threadId))\r\n                      );\r\n\r\n        // NO UPDATE/DELETE allowed for messages (Immutable history)\r\n        allow update, delete: if false; \r\n      }\r\n    }\r\n\r\n    // --- PINS (Existing logic maintained) ---\r\n    match /pins/{pinId} {\r\n      allow read: if true; // Public read\r\n      allow create: if isSignedIn() && request.resource.data.ownerUid == request.auth.uid;\r\n      allow update, delete: if isSignedIn() && (resource.data.ownerUid == request.auth.uid || request.auth.token.isAdmin == true);\r\n    }\r\n\r\n    // --- RATINGS (Existing logic maintained) ---\r\n    match /ratings/{ratingId} {\r\n      allow read: if true; // Public read\r\n      allow create, update: if isSignedIn() && request.resource.data.userId == request.auth.uid;\r\n    }\r\n\r\n    // --- REPORTS (Existing logic maintained) ---\r\n    match /reports/{reportId} {\r\n      allow create: if isSignedIn(); // Any signed-in user can report\r\n      allow read, update, delete: if false; // Only admins (backend) can manage\r\n    }\r\n\r\n    // --- NOTIFICATIONS (Existing logic maintained) ---\r\n    match /notifications/{notifId} {\r\n      allow read: if isSignedIn() && resource.data.targetUid == request.auth.uid;\r\n      allow create: if isSignedIn(); // Allow users to trigger notifications\r\n      allow update: if isSignedIn() && resource.data.targetUid == request.auth.uid; // Mark as read\r\n      allow delete: if isSignedIn() && resource.data.targetUid == request.auth.uid;\r\n    }\r\n    \r\n    // --- USERS (Existing logic maintained) ---\r\n    match /users/{userId} {\r\n      allow read: if isSignedIn();\r\n      allow write: if isSignedIn() && request.auth.uid == userId;\r\n    }\r\n    \r\n    // --- DELETED PINS (Black Box Audit) ---\r\n    match /deleted_pins/{docId} {\r\n        allow read: if false; // Only admins via Admin SDK\r\n        allow create: if isSignedIn(); // Allow app to archive deleted pins\r\n    }\r\n  }\r\n}\r\n","name":"firestore.rules"}]},"createTime":"2026-02-19T03:13:12.622879Z","metadata":{"services":["cloud.firestore"]}}
[debug] [2026-02-19T03:13:12.331Z] [rules] created ruleset projects/mmcplayground/rulesets/36435d1b-3cf8-4959-b36e-a4281e4c9a4f
[debug] [2026-02-19T03:13:12.333Z] [rules] releasing cloud.firestore/(default) with ruleset projects/mmcplayground/rulesets/36435d1b-3cf8-4959-b36e-a4281e4c9a4f
[debug] [2026-02-19T03:13:12.335Z] Checked if tokens are valid: true, expires at: 1771474388966
[debug] [2026-02-19T03:13:12.335Z] Checked if tokens are valid: true, expires at: 1771474388966
[debug] [2026-02-19T03:13:12.336Z] >>> [apiv2][query] PATCH https://firebaserules.googleapis.com/v1/projects/mmcplayground/releases/cloud.firestore/(default) [none]
[debug] [2026-02-19T03:13:12.336Z] >>> [apiv2][body] PATCH https://firebaserules.googleapis.com/v1/projects/mmcplayground/releases/cloud.firestore/(default) {"release":{"name":"projects/mmcplayground/releases/cloud.firestore/(default)","rulesetName":"projects/mmcplayground/rulesets/36435d1b-3cf8-4959-b36e-a4281e4c9a4f"}}
[debug] [2026-02-19T03:13:12.698Z] <<< [apiv2][status] PATCH https://firebaserules.googleapis.com/v1/projects/mmcplayground/releases/cloud.firestore/(default) 200
[debug] [2026-02-19T03:13:12.699Z] <<< [apiv2][body] PATCH https://firebaserules.googleapis.com/v1/projects/mmcplayground/releases/cloud.firestore/(default) {"name":"projects/mmcplayground/releases/cloud.firestore","rulesetName":"projects/mmcplayground/rulesets/36435d1b-3cf8-4959-b36e-a4281e4c9a4f","createTime":"2026-02-14T17:33:13.420231Z","updateTime":"2026-02-19T03:13:12.944502Z"}
[debug] [2026-02-19T03:13:12.699Z] [rules] updated release projects/mmcplayground/releases/cloud.firestore
[info] +  firestore: released rules firestore.rules to cloud.firestore 
[info] 
[info] +  Deploy complete! 
[info] 
[info] Project Console: https://console.firebase.google.com/project/mmcplayground/overview
[debug] [2026-02-19T03:13:18.526Z] Error: Timed out.
    at Timeout._onTimeout (C:\Users\Michele\AppData\Roaming\npm\node_modules\firebase-tools\lib\utils.js:275:49)
    at listOnTimeout (node:internal/timers:581:17)
    at process.processTimers (node:internal/timers:519:7)
[error] 
[error] Error: An unexpected error has occurred.
